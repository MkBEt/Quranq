<script type="module">
    import './commoncode'

async function ready() {
  document.querySelector('#mycontainer').insertAdjacentHTML('beforeend', window.searchBar)
  let params = new window.URLSearchParams(document.location.search);
  let chapter = params.get("chapter");
  let verse = params.get("verse")

  if(chapter === null || verse === null)
  return

  showSpinningWheel('#mycontainer','beforeend')
  let [editionsJSON, isocodes] = await getJSON(['editions', 'isocodes/iso-codes'])
  // sorted by language
  let edtionsLangArr = Object.values(editionsJSON).map(e => [e.name, e.language, e.direction,e.author]).sort((a,b)=>a[1].localeCompare(b[1]))
  let linksArr = []
  // Table of content
  let tableElem = getElementFromHTML(tableContainer).querySelector('.table')
  let uniqueLangs = [...new window.Set(edtionsLangArr.map(e => e[1]))].sort()
  for (let lang of uniqueLangs) {
    let aElem = getElement('a', { href: `#${lang.toLowerCase()}` })
    aElem.innerText = lang
    let tr = getElement('tr')
    let td = getElement('td', { class: 'text-center' })
    td.appendChild(aElem)
    tr.appendChild(td)
    tableElem.querySelector('tbody').appendChild(tr)
  }
  removeSpinningWheel()

  // Create endpoints for parallel fetch
  for (let [editionName] of edtionsLangArr)
    linksArr.push(`editions/${editionName}/${chapter}/${verse}`)

  document.querySelector('#mycontainer').appendChild(tableElem)
  showSpinningWheel('#mycontainer','beforeend')
  let dataArr = await window.getJSON(linksArr)
  let count = 0
  let langCheck = []
  for (let [editionName, lang, dirval,authorName] of edtionsLangArr) {
    // create language heading only if one doesn't exists
    if (!langCheck.includes(lang)) {
      let h2 = getElement('h2', { id: lang.toLowerCase(), 'class': 'text-center' })
      let aElem = getElement('a', { href: `#${lang.toLowerCase()}`, class: "link-dark" })
      aElem.innerText = lang
      h2.appendChild(aElem)
      document.querySelector('#mycontainer').appendChild(h2)
    }
    document.querySelector('#mycontainer').appendChild(getQuranCardElem(dataArr[count], editionName, dirval, lang,authorName, isocodes))

    langCheck.push(lang)

    count++;
  }

  removeSpinningWheel()


}

document.addEventListener("DOMContentLoaded", ready);

</script>